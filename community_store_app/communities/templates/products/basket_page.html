{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jackpot | {% block title %}{% endblock title %}</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css"
      integrity="sha384-jLKHWM3JRmfMU0A5x5AkjWkw/EYfGUAGagvnfryNV3F9VqM98XiIH7VBGVoxVSc7"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />

    <!-- stuff for stripe  -->
    <script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <main>
      <h4>Your basket</h4>

      <ul class="list-group">
        {% for product in products %}
        <li class="list-group-item d-flex justify-content-between">
          <div>
            <img src="../../../media/{{product.image}}" alt="" />
            <h6>{{product.title}}</h6>
            <small>{{product.description}}</small>
          </div>
          <span>£{{product.price|floatformat:2}}</span>
        </li>
        {% endfor %}
        <li class="list-group-item d-flex justify-content-between">
          <span>Subtotal (GBP)</span>
          <strong>£{{subtotal|floatformat:2}}</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Total (GBP)</span>
          <strong>£{{total|floatformat:2}}</strong>
        </li>
      </ul>

      <!-- <a class="link" href="{% url 'create-checkout-session' %}"
          ><button>Checkout</button></a
          > -->

      <form
        action="http://localhost:8000/communities/create-checkout-session/"
        method="POST"
      >
        {% csrf_token %}
        <button type="submit" id="checkout-button">Checkout</button>
      </form>
    </main>
  </body>

  <!--note: might need js script. if so, see https://youtu.be/722A27IoQnk @20:40 mins -->
  <script type="text/javascript">
    //create an instance of hte stripe object with your publishable API jey
    let stripe = Stripe(
      "pk_test_51K3iqqHkKUv8ltDUO972oz2k6BWFYqqjE1URIbakFQwWMbBs2KwhqbwEb6xkMX1zjlW9jGL9XCLTIpvTKHQ6fq41001K1s7tHQ"
    );
    let checkoutButton = document.getElementById("checkout-button");

    checkoutButton.addEventListener("click", () => {
      console.log("1");
      fetch("http://localhost:8000/communities/create-checkout-session/", {
        method: "POST",
      })
        .then((response) => {
          console.log("2");
          return response.json();
        })
        .then((session) => {
          console.log("3");
          return stripe.redirectToCheckout({ sessionId: session.id });
        })
        .then((result) => {
          console.log("4");
          if (result.error) {
            alert(result.error.message);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    });
  </script>
</html>
